// Generated by CoffeeScript 1.4.0
(function() {
  var $, Backbone, Buffer, DROWSY_URL, Drowsy, TEST_COLLECTION, TEST_DB, WAKEFUL_URL, Wakeful, WebSocket, btoa, should, _,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  if (typeof window !== "undefined" && window !== null) {
    $ = window.$;
    _ = window._;
    Backbone = window.Backbone;
    Drowsy = window.Drowsy;
    Wakeful = window.Wakeful;
    WebSocket = window.WebSocket;
  } else {
    $ = require('jquery');
    _ = require('underscore');
    Backbone = require('backbone');
    Backbone.$ = $;
    Drowsy = require('../backbone.drowsy').Drowsy;
    Wakeful = require('../wakeful').Wakeful;
    should = require('chai').should();
    WebSocket = require('ws');
  }

  DROWSY_URL = "http://localhost:9292";

  WAKEFUL_URL = "ws://localhost:7777";

  TEST_DB = 'drowsy_test';

  TEST_COLLECTION = 'tests';

  if ((typeof TEST_USERNAME !== "undefined" && TEST_USERNAME !== null) && (typeof TEST_PASSWORD !== "undefined" && TEST_PASSWORD !== null)) {
    Buffer = require('buffer').Buffer;
    btoa = function(str) {
      return (new Buffer(str || "", "ascii")).toString("base64");
    };
    Backbone.$.ajaxSetup({
      beforeSend: function(xhr) {
        return xhr.setRequestHeader('Authorization', 'Basic ' + btoa(TEST_USERNAME + ':' + TEST_PASSWORD));
      }
    });
  }

  describe('Wakeful', function() {
    this.timeout(3000);
    this.slow(1000);
    before(function() {
      var TestDoc;
      this.server = new Drowsy.Server(DROWSY_URL);
      this.db = this.server.database(TEST_DB);
      TestDoc = (function(_super) {

        __extends(TestDoc, _super);

        function TestDoc() {
          return TestDoc.__super__.constructor.apply(this, arguments);
        }

        return TestDoc;

      })(this.db.Document(TEST_COLLECTION));
      return this.TestDoc = TestDoc;
    });
    beforeEach(function() {
      Wakeful.websockets = {};
      return Wakeful.subs = {};
    });
    afterEach(function(done) {
      var dfs, url, ws, _ref;
      dfs = [];
      _ref = Wakeful.websockets;
      for (url in _ref) {
        ws = _ref[url];
        dfs.push(ws.ensuredClose());
      }
      return $.when.apply($, dfs).done(function() {
        return done();
      });
    });
    return describe(".wake", function() {
      it('should enhance Drowsy.Document with wakeful functionality', function(done) {
        var doc;
        doc = new this.TestDoc();
        return (Wakeful.wake(doc, WAKEFUL_URL)).done(function() {
          doc.should.have.property('tunein');
          doc.tunein.should.be.a('function');
          doc.should.have.property('broadcast');
          doc.broadcast.should.be.a('function');
          return done();
        });
      });
      it('should not create more than one WebSocket per ws URL', function(done) {
        var df1, df2, df3, doc1, doc2, doc3, doc4;
        doc1 = new this.TestDoc();
        doc2 = new this.TestDoc();
        doc3 = new this.TestDoc();
        doc4 = new this.TestDoc();
        df1 = Wakeful.wake(doc1, WAKEFUL_URL);
        df2 = Wakeful.wake(doc2, WAKEFUL_URL);
        df3 = Wakeful.wake(doc3, WAKEFUL_URL);
        return $.when(df1, df2, df3).done(function() {
          var df4;
          Object.keys(Wakeful.websockets).length.should.equal(1);
          doc1.websocket.should.equal(doc2.websocket);
          doc2.websocket.should.equal(doc3.websocket);
          df4 = Wakeful.wake(doc4, WAKEFUL_URL + "/foo");
          return df4.done(function() {
            Object.keys(Wakeful.websockets).length.should.equal(2);
            doc1.websocket.should.not.equal(doc4.websocket);
            return done();
          });
        });
      });
      it('should create websockets that support ensuredClose()', function(done) {
        var df1, df2, df3, doc1, doc2, doc3;
        doc1 = new this.TestDoc();
        doc2 = new this.TestDoc();
        doc3 = new this.TestDoc();
        df1 = Wakeful.wake(doc1, WAKEFUL_URL);
        df2 = Wakeful.wake(doc2, WAKEFUL_URL);
        df3 = Wakeful.wake(doc3, WAKEFUL_URL);
        return $.when(df1, df2, df3).done(function() {
          doc1.websocket.should.have.property('ensuredClose');
          doc2.websocket.should.have.property('ensuredClose');
          doc3.websocket.should.have.property('ensuredClose');
          return doc1.websocket.ensuredClose().done(function() {
            doc1.websocket.readyState.should.equal(WebSocket.CLOSED);
            doc2.websocket.readyState.should.equal(WebSocket.CLOSED);
            doc3.websocket.readyState.should.equal(WebSocket.CLOSED);
            return done();
          });
        });
      });
      describe("#tunein", function() {
        it('should return a $.Deferred', function(done) {
          var doc;
          console.log('should return a $.Deferred');
          doc = new this.TestDoc();
          return (Wakeful.wake(doc, WAKEFUL_URL)).done(function() {
            var sub;
            sub = doc.tunein();
            sub.should.have.property('resolve');
            sub.resolve.should.be.a('function');
            return sub.done(function() {
              return done();
            });
          });
        });
        it('should make sure a WebSocket is open', function(done) {
          var doc, sub;
          console.log('should make sure a WebSocket is open');
          doc = new this.TestDoc();
          Wakeful.wake(doc, WAKEFUL_URL);
          sub = doc.tunein();
          return sub.always(function() {
            doc.websocket.readyState.should.equal(WebSocket.OPEN);
            return done();
          });
        });
        it('should register a subscription with Wakeful', function(done) {
          var doc, sub;
          console.log('should register a subscription with Wakeful');
          doc = new this.TestDoc();
          Wakeful.wake(doc, WAKEFUL_URL);
          sub = doc.tunein();
          return sub.done(function() {
            Wakeful.subs[doc.resourceUrl()].length.should.equal(1);
            Wakeful.subs[doc.resourceUrl()].should.include(doc);
            return done();
          });
        });
        it('should allow multiple subscriptions for the same URL', function(done) {
          var docA, docB, subA, subB;
          docA = new this.TestDoc();
          docB = new this.TestDoc();
          docB.set('_id', docA.id);
          Wakeful.wake(docA, WAKEFUL_URL);
          Wakeful.wake(docB, WAKEFUL_URL);
          subA = docA.tunein();
          subB = docB.tunein();
          console.log("A", docA.resourceUrl());
          console.log("B", docB.resourceUrl());
          subA.done(function() {
            return console.log("A", "DONE");
          });
          subB.done(function() {
            return console.log("B", "DONE");
          });
          return $.when(subA, subB).done(function() {
            Wakeful.subs[docA.resourceUrl()].length === 2;
            return done();
          });
        });
        return it('should trigger wakeful:subscription and then resolve', function(done) {
          var doc1, doc2, subA, subB;
          doc1 = new this.TestDoc();
          doc2 = new this.TestDoc();
          Wakeful.wake(doc1, WAKEFUL_URL);
          Wakeful.wake(doc2, WAKEFUL_URL);
          subA = doc1.tunein();
          subB = doc2.tunein();
          console.log("A", doc1.resourceUrl());
          console.log("B", doc2.resourceUrl());
          subA.done(function() {
            return console.log("A", "DONE");
          });
          subB.done(function() {
            return console.log("B", "DONE");
          });
          return $.when(subA, subB).done(function() {
            Wakeful.subs[doc1.resourceUrl()].length === 2;
            return done();
          });
        });
      });
      return describe("#broadcast", function() {
        return it("should send an update from one Drowsy.Document to another Drowsy.Document with the same URL", function(done) {
          var doc1, doc2;
          doc1 = new this.TestDoc();
          doc2 = new this.TestDoc();
          return doc1.save().done(function() {
            doc2.set('_id', doc1.id);
            doc2.url().should.equal(doc1.url());
            return doc2.save().done(function() {
              var conn1, conn2, sub1, sub2;
              console.log("Doc2 saved");
              Wakeful.wake(doc1, WAKEFUL_URL);
              Wakeful.wake(doc2, WAKEFUL_URL);
              conn1 = doc1.connect();
              conn2 = doc2.connect();
              sub1 = false;
              sub2 = false;
              doc1.on('wakeful:tuneind', function() {
                return sub1 = true;
              });
              doc2.on('wakeful:tuneind', function() {
                return sub2 = true;
              });
              conn1.state().should.equal('pending');
              conn2.state().should.equal('pending');
              return $.when(conn1, conn2).done(function() {
                var bc, rand;
                conn1.state().should.equal('resolved');
                conn2.state().should.equal('resolved');
                sub1.should.be["true"];
                sub2.should.be["true"];
                console.log("Both open");
                rand = Math.random();
                doc1.set('foo', rand);
                doc1.get('foo').should.equal(rand);
                doc2.has('foo').should.be["false"];
                doc1.wid = 'doc1';
                doc2.wid = 'doc2';
                doc2.on('change', function() {
                  console.log("Doc2 changed");
                  doc2.get('foo').should.equal(rand);
                  return done();
                });
                bc = doc1.broadcast('update', doc1.toJSON(), doc1.wid);
                return bc.progress(function(n) {
                  return console.log(n);
                });
              });
            });
          });
        });
      });
    });
  });

}).call(this);
